<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLADIM</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #374151;
      --text-light: #6b7280;
      --primary: #0d9488;
      --primary-hover: #0f766e;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --danger-light: #fee2e2;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #ecfdf5, #cffafe);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }

    h1 { text-align: center; font-size: 2rem; font-weight: 700; margin-bottom: .5rem; }
    p.subtitle { text-align: center; color: var(--text-light); margin-bottom: 2rem; }

    .main-layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; }
    }

    .score-section h2 { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--text); }

    .tab-container {
        border: 1px solid var(--border);
        border-radius: .75rem;
        overflow: hidden;
        background-color: var(--card);
    }

    .tab-headers { display: flex; background-color: #f9fafb; }
    .tab-header {
        flex-grow: 1; padding: 1rem; text-align: center; cursor: pointer;
        font-weight: 600; color: var(--text-light);
        border-bottom: 1px solid var(--border);
        transition: all 0.2s ease-in-out;
    }
    .tab-header.active { color: var(--primary); background-color: var(--card); border-bottom-color: transparent; }
    
    .tab-content { display: none; padding: 1.5rem; }
    .tab-content.active { display: block; }
    
    /* Formul√°rio de Adi√ß√£o */
    .add-item-form {
      display: flex;
      gap: .75rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #f9fafb;
      border-radius: .75rem;
    }
    .add-item-form input {
      flex-grow: 1;
      border: 1px solid var(--border);
      border-radius: .5rem;
      padding: .6rem .8rem;
      font-size: .9rem;
    }
    .add-item-form input:focus { outline: 2px solid var(--primary); border-color: transparent; }
    .add-item-form input[type="number"] { max-width: 80px; }
    .add-item-form button {
      background: var(--primary);
      color: white;
      padding: 0 1.25rem;
      border-radius: .5rem;
      font-weight: 600;
      flex-shrink: 0;
    }
    .add-item-form button:hover { background: var(--primary-hover); }

    /* Remove arrows from number inputs */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
    }
    input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { padding: .75rem 1rem; border-bottom: 1px solid var(--border); font-size: .9rem; text-align: center; vertical-align: middle; }
    th { background: #f3f4f6; color: var(--text-light); font-weight: 600; font-size: .85rem; text-transform: uppercase; }
    td:first-child { text-align: left; font-weight: 500; word-break: break-word; }
    tr:last-child td { border-bottom: none; }
    
    /* Estilos espec√≠ficos da Tabela de Tarefas para ajuste de colunas */
    #tasks th:nth-child(n+2):nth-child(-n+8),
    #tasks td:nth-child(n+2):nth-child(-n+8) {
        width: 45px;
        padding-left: .5rem;
        padding-right: .5rem;
    }
    #tasks th:nth-child(9),
    #tasks td:nth-child(9) {
        width: 65px;
    }
    #tasks th:last-child,
    #tasks td:last-child {
        width: 50px;
    }

    .task-checkbox {
      appearance: none; width: 22px; height: 22px;
      border: 2px solid var(--border); border-radius: .4rem;
      cursor: pointer; transition: all .2s; vertical-align: middle;
    }
    .task-checkbox:checked {
      background-color: var(--primary); border-color: var(--primary);
      background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.2 4.8a1 1 0 0 1 0 1.4l-5 5a1 1 0 0 1-1.4 0l-2-2a1 1 0 0 1 1.4-1.4L6.5 9.1l4.3-4.3a1 1 0 0 1 1.4 0z'/%3e%3c/svg%3e");
      background-size: 100% 100%; background-position: center;
    }

    button { border: none; cursor: pointer; border-radius: .5rem; transition: all .2s; font-weight: 600; }
    .btn-primary { background: var(--primary); color: white; padding: .75rem 1.25rem; width: 100%; margin-top: 1rem; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-circle { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; font-size: 1rem; margin: 0 5px; }
    .btn-plus { background: var(--primary); color: white; } .btn-plus:hover { background: var(--primary-hover); }
    .btn-minus { background: var(--danger-light); color: var(--danger); } .btn-minus:hover { background: #fecaca; }
    .btn-delete {
      background: transparent; color: #9ca3af;
      padding: 0; width: 28px; height: 28px;
      border-radius: 50%;
    }
    .btn-delete:hover { background: var(--danger-light); color: var(--danger); }

    .score-card { background: #f3f4f6; border: 1px solid var(--border); padding: 1.5rem; border-radius: .75rem; display: flex; flex-direction: column; gap: 1rem; }
    .score-row { display: flex; justify-content: space-between; align-items: center; }
    .score-main { font-size: 1.5rem; font-weight: 700; padding: .25rem .75rem; border-radius: .5rem; }
    .score-positive { color: var(--primary); background: #ccfbf1; }
    .score-negative { color: var(--danger); background: #fee2e2; }
    
    /* Topbar (email + logout) */
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: .95rem; color: #374151; }
    .user-email { font-weight: 600; color: #374151; display:inline-flex; align-items:center; }
    .logout-link { color: var(--danger); border: 1px solid var(--border); padding: .4rem .6rem; border-radius: .4rem; text-decoration: none; }
    .logout-link:hover { background: #fee2e2; color: var(--danger); }
     .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; background:#10b981; margin-right:8px; box-shadow: 0 0 0 2px rgba(16,185,129,.20), 0 0 6px rgba(16,185,129,.65); vertical-align:middle; animation: pulse 1.8s ease-in-out infinite; }
     @keyframes pulse {
       0% { box-shadow: 0 0 0 2px rgba(16,185,129,.20), 0 0 6px rgba(16,185,129,.65); }
       50% { box-shadow: 0 0 0 3px rgba(16,185,129,.30), 0 0 10px rgba(16,185,129,.85); }
       100% { box-shadow: 0 0 0 2px rgba(16,185,129,.20), 0 0 6px rgba(16,185,129,.65); }
     }
  </style>
</head>
<body>
  <div id="auth" style="display:none">
    <div class="container" style="max-width: 500px;">
      <h1>Entrar</h1>
      <p class="subtitle">Fa√ßa login para acessar seu planejador</p>
      <div style="display:flex; flex-direction:column; gap:1rem; align-items:center;">
        <a href="/auth/google" id="google-login" style="display:inline-flex; gap:.6rem; align-items:center; background:#fff; border:1px solid var(--border); padding:.75rem 1rem; border-radius:.5rem; font-weight:600; color:#374151; text-decoration:none; box-shadow:0 4px 16px rgba(0,0,0,0.06)">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3c-1.7 4.9-6.4 8-11.3 8c-6.9 0-12.5-5.6-12.5-12.5S17.1 11 24 11c3.2 0 6.2 1.2 8.5 3.2l5.7-5.7C34.6 5.4 29.5 3 24 3C12.4 3 3 12.4 3 24s9.4 21 21 21s21-9.4 21-21c0-1.2-.1-2.5-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.6 16.1 18.9 13 24 13c3.2 0 6.2 1.2 8.5 3.2l5.7-5.7C34.6 5.4 29.5 3 24 3C16.1 3 9.5 7.1 6.3 14.7z"/><path fill="#4CAF50" d="M24 45c5.4 0 10.4-2.1 14.1-5.6l-6.5-5.5C29.8 35.9 27 37 24 37c-4.9 0-9.1-3.1-11.1-7.8l-6.5 5.1C9.6 41.6 16.3 45 24 45z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.7 4.9-6.4 8-11.3 8c-6.9 0-12.5-5.6-12.5-12.5S17.1 11 24 11c3.2 0 6.2 1.2 8.5 3.2l5.7-5.7C34.6 5.4 29.5 3 24 3C12.4 3 3 12.4 3 24s9.4 21 21 21s21-9.4 21-21c0-1.2-.1-2.5-.4-3.5z"/></svg>
          Entrar com Google
        </a>
      </div>
    </div>
  </div>

  <div id="app" style="display:none">
    <div class="container">
      <div class="topbar">
        <div class="user-email"><span class="status-dot" aria-label="Online" title="Conectado"></span><span id="user-email">...</span></div>
        <a class="logout-link" id="logout-link" href="/logout" title="Sair da conta">Sair</a>
      </div>
    <h1>Planejador de Tarefas</h1>
    <p class="subtitle">Transforme sua rotina em um jogo e conquiste suas metas.</p>

    <div class="main-layout">
      <div class="tab-container">
        <div class="tab-headers">
          <div class="tab-header active" data-tab="tasks">üìã Tarefas</div>
          <div class="tab-header" data-tab="rewards">üéÅ Recompensas</div>
        </div>
        
        <div id="tasks" class="tab-content active">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>S√°b</th><th>Dom</th>
                <th>Pts</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tasks-table-body"></tbody>
          </table>
          <form class="add-item-form" id="add-task-form">
            <input type="text" id="new-task-name" placeholder="Nome da nova tarefa" required>
            <input type="number" id="new-task-points" placeholder="Pontos" required min="1">
            <button type="submit">Adicionar</button>
          </form>
        </div>
        
        <div id="rewards" class="tab-content">
          <table>
            <thead><tr><th>Nome</th><th>Pontos</th><th>Qtd</th><th></th></tr></thead>
            <tbody id="rewards-table-body"></tbody>
          </table>
          <form class="add-item-form" id="add-reward-form">
            <input type="text" id="new-reward-name" placeholder="Nome da nova recompensa" required>
            <input type="number" id="new-reward-points" placeholder="Pontos" required min="1">
            <button type="submit">Adicionar</button>
          </form>
        </div>
      </div>

      <div class="score-section">
        <h2>‚≠ê Pontua√ß√£o</h2>
        <div class="score-card">
          <div class="score-row"><span>Saldo Anterior</span><span id="saldo-anterior">0</span></div>
          <div class="score-row"><strong>Pontos da Semana</strong><span id="pontos-semana">+0</span></div>
          <hr style="border-color: var(--border); border-style: dashed;">
          <div class="score-row">
            <strong>Pontos Acumulados</strong>
            <span id="pontos-acumulados" class="score-main score-positive">0</span>
          </div>
          <button id="reset-button" class="btn-primary">Fechar Semana e Salvar Pontos</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // --- Estado da Aplica√ß√£o ---
    let tasks = [];
    let rewards = [];
    let saldoAnterior = 0;
    let taskChecks = {};


    
    // --- Persist√™ncia de Dados ---
    function saveState() {
      // Persistir no backend
      const state = { saldoAnterior, tasks, rewards, taskChecks };
      fetch('/api/state', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(state)
      }).catch(err => console.error('Falha ao salvar estado:', err));
    }

    // Salvar listas separadas
    function saveTasks() {
      fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tasks)
      }).catch(err => console.error('Falha ao salvar tarefas:', err));
    }

    function saveRewards() {
      fetch('/api/rewards', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(rewards)
      }).catch(err => console.error('Falha ao salvar recompensas:', err));
    }

    async function loadState() {
      try {
        const [stateRes, tasksRes, rewardsRes] = await Promise.all([
          fetch('/api/state'),
          fetch('/api/tasks'),
          fetch('/api/rewards')
        ]);
        const state = await stateRes.json();
        const tasksData = await tasksRes.json();
        const rewardsData = await rewardsRes.json();

        saldoAnterior = state.saldoAnterior || 0;
        taskChecks = state.taskChecks || {};
        tasks = Array.isArray(tasksData) ? tasksData : [];
        rewards = Array.isArray(rewardsData) ? rewardsData : [];
        // Renderizar ap√≥s o carregamento
        renderTasks();
        renderRewards();
        updateScores();
      } catch (e) {
        // Fallback para backend indispon√≠vel
        tasks = [];
        rewards = [];
        // Renderizar mesmo em fallback
        renderTasks();
        renderRewards();
        updateScores();
      }
    }

    // --- Fun√ß√µes de Renderiza√ß√£o ---
    function renderTasks() {
      const tbody = document.getElementById("tasks-table-body");
      tbody.innerHTML = "";
      tasks.forEach((task, taskIndex) => {
        const tr = document.createElement("tr");
        tr.dataset.index = taskIndex;
        let cells = `<td class="task-name">${task.name}</td>`;
        for (let day = 0; day < 7; day++) {
          const checkId = `task-${taskIndex}-${day}`;
          const checked = taskChecks[checkId] ? "checked" : "";
          cells += `<td><input type="checkbox" class="task-checkbox" data-id="${checkId}" ${checked}></td>`;
        }
        cells += `<td>${task.points}</td>`;
        cells += `<td><button class="btn-delete delete-task" title="Excluir tarefa">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                  </button></td>`;
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      });
    }

    function renderRewards() {
      const tbody = document.getElementById("rewards-table-body");
      tbody.innerHTML = "";
      rewards.forEach((reward, rewardIndex) => {
        if (reward.quantity === undefined) reward.quantity = 0;
        const tr = document.createElement("tr");
        tr.dataset.index = rewardIndex;
        tr.innerHTML = `
          <td>${reward.name}</td>
          <td>${reward.points}</td>
          <td>
            <button class="btn-circle btn-minus" aria-label="Remover ${reward.name}">‚àí</button>
            <span class="reward-qty" style="display: inline-block; width: 25px; text-align: center;">${reward.quantity}</span>
            <button class="btn-circle btn-plus" aria-label="Adicionar ${reward.name}">+</button>
          </td>
          <td><button class="btn-delete delete-reward" title="Excluir recompensa">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
          </button></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // --- Fun√ß√µes de L√≥gica e C√°lculo ---
    function calculateWeeklyPoints() {
      let pontosGanhos = 0;
      Object.keys(taskChecks).forEach(checkId => {
          if(taskChecks[checkId]) {
              const [_, taskIndexStr] = checkId.split('-');
              const taskIndex = parseInt(taskIndexStr, 10);
              if(tasks[taskIndex]) {
                  pontosGanhos += tasks[taskIndex].points;
              }
          }
      });
      return pontosGanhos;
    }

    function calculateRewardsCost() {
      return rewards.reduce((total, reward) => total + (reward.quantity || 0) * reward.points, 0);
    }

    function updateScores() {
      const pontosSemana = calculateWeeklyPoints();
      const pontosRecompensas = calculateRewardsCost();
      const pontosAcumulados = saldoAnterior + pontosSemana - pontosRecompensas;

      document.getElementById("saldo-anterior").textContent = saldoAnterior;
      document.getElementById("pontos-semana").textContent = `+${pontosSemana}`;
      document.getElementById("pontos-acumulados").textContent = pontosAcumulados;
      
      const acumuladoEl = document.getElementById("pontos-acumulados");
      acumuladoEl.classList.toggle("score-negative", pontosAcumulados < 0);
      acumuladoEl.classList.toggle("score-positive", pontosAcumulados >= 0);

      // salvar no backend
      saveState();
    }
    
    // --- Modal de Confirma√ß√£o (custom) ---
    function ensureModalStyles() {
      if (document.getElementById('confirm-modal-styles')) return;
      const style = document.createElement('style');
      style.id = 'confirm-modal-styles';
      style.textContent = `
        .cm-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;animation:cm-fade-in .18s ease forwards}
        .cm-backdrop{position:absolute;inset:0;background:rgba(15,23,42,.50);backdrop-filter:blur(3px)}
        .cm-dialog{position:relative;background:#fff;color:#0f172a;border-radius:12px;box-shadow:0 24px 60px rgba(2,6,23,.22);width:min(92vw,420px);padding:22px 24px;border:1px solid rgba(2,6,23,.08);z-index:1;transform:translateY(6px) scale(0.98);animation:cm-pop .18s ease forwards}
        .cm-title{margin:0 0 14px;font-size:1.25rem;font-weight:700;letter-spacing:.2px}
        .cm-actions{display:flex;align-items:center;justify-content:flex-start;gap:16px;margin-top:4px}
        .cm-btn{padding:10px 16px;border-radius:10px;border:none;background:#f8fafc;color:#0f172a;cursor:pointer;transition:.15s ease;font-weight:600}
        .cm-btn:hover{background:#eef2f7}
        .cm-btn:focus{outline:none}
        .cm-btn:focus-visible{outline:2px solid rgba(59,130,246,.45);outline-offset:2px}
        .cm-btn-primary{background:var(--primary);color:#fff}
        .cm-btn-primary:hover{background:var(--primary-hover)}
        .cm-btn-danger{background:var(--danger);color:#fff}
        .cm-btn-danger:hover{background:var(--danger-hover)}
        @keyframes cm-fade-in{to{opacity:1}}
        @keyframes cm-pop{to{transform:translateY(0) scale(1)}}
      `;
      document.head.appendChild(style);
    }

    function showConfirmModal({ title = 'Confirma√ß√£o', confirmText = 'Confirmar', cancelText = 'Cancelar', variant = 'primary' } = {}) {
      return new Promise((resolve) => {
        ensureModalStyles();

        const okClass = variant === 'danger' ? 'cm-btn cm-btn-danger' : 'cm-btn cm-btn-primary';

        const overlay = document.createElement('div');
        overlay.className = 'cm-overlay';
        overlay.innerHTML = `
          <div class="cm-backdrop" aria-hidden="true"></div>
          <div class="cm-dialog" role="dialog" aria-modal="true" aria-labelledby="cm-title">
            <h3 class="cm-title" id="cm-title">${title}</h3>
            <div class="cm-actions">
              <button type="button" class="cm-btn" id="cm-cancel">${cancelText}</button>
              <button type="button" class="${okClass}" id="cm-ok">${confirmText}</button>
            </div>
          </div>
        `;

        const remove = (result) => {
          document.removeEventListener('keydown', onKey);
          overlay.remove();
          resolve(result);
        };

        const onKey = (e) => {
          if (e.key === 'Escape') remove(false);
          if (e.key === 'Enter') remove(true);
        };

        overlay.querySelector('.cm-backdrop').addEventListener('click', () => remove(false));
        overlay.querySelector('#cm-cancel').addEventListener('click', () => remove(false));
        overlay.querySelector('#cm-ok').addEventListener('click', () => remove(true));

        document.addEventListener('keydown', onKey);
        document.body.appendChild(overlay);

        requestAnimationFrame(() => overlay.querySelector('#cm-ok')?.focus());
      });
    }

    // --- Event Listeners ---
    document.getElementById("tasks-table-body").addEventListener('change', (e) => {
        if(e.target.classList.contains('task-checkbox')) {
            taskChecks[e.target.dataset.id] = e.target.checked;
            updateScores();
        }
    });

    // alterar listener para usar modal de confirma√ß√£o ao deletar tarefa
    document.getElementById("tasks-table-body").addEventListener('click', async (e) => {
        const deleteButton = e.target.closest('.delete-task');
        if (deleteButton) {
            const tr = deleteButton.closest('tr');
            const taskIndex = parseInt(tr.dataset.index, 10);
            const taskName = tasks[taskIndex].name;
            const proceed = await showConfirmModal({
              title: 'Deseja mesmo Excluir?',
              confirmText: 'Excluir',
              cancelText: 'Cancelar',
              variant: 'danger'
            });
            if (!proceed) return;
            tasks.splice(taskIndex, 1);
            Object.keys(taskChecks).forEach(key => {
                if (key.startsWith(`task-${taskIndex}-`)) {
                    delete taskChecks[key];
                }
            });
            renderTasks();
            updateScores();
            saveTasks();
        }
    });

    // Listener para a tabela de recompensas (confirm modal ao excluir)
    document.getElementById("rewards-table-body").addEventListener('click', async (e) => {
      const target = e.target;
      const tr = target.closest('tr');
      if (!tr) return;
      
      const rewardIndex = parseInt(tr.dataset.index, 10);
      const reward = rewards[rewardIndex];

      if (target.closest('.btn-plus')) {
          reward.quantity = (reward.quantity || 0) + 1;
      } else if (target.closest('.btn-minus')) {
          if (reward.quantity > 0) {
              reward.quantity--;
          }
      } else if (target.closest('.delete-reward')) {
          const rewardName = rewards[rewardIndex].name;
          const proceed = await showConfirmModal({
            title: 'Deseja mesmo Excluir?',
            confirmText: 'Excluir',
            cancelText: 'Cancelar',
            variant: 'danger'
          });
          if (!proceed) return;
          rewards.splice(rewardIndex, 1);
          renderRewards();
          updateScores();
          saveRewards();
          return;
      }
      
      renderRewards();
      updateScores();
      saveRewards();
    });
    
    document.getElementById("add-task-form").addEventListener('submit', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('new-task-name');
        const pointsInput = document.getElementById('new-task-points');
        const name = nameInput.value.trim();
        const points = parseInt(pointsInput.value, 10);

        if (name && points > 0) {
            tasks.push({ name, points });
            renderTasks();
            updateScores();
            saveTasks();
            nameInput.value = '';
            pointsInput.value = '';
            nameInput.focus();
        }
    });

    document.getElementById("add-reward-form").addEventListener('submit', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('new-reward-name');
        const pointsInput = document.getElementById('new-reward-points');
        const name = nameInput.value.trim();
        const points = parseInt(pointsInput.value, 10);

        if (name && points > 0) {
            rewards.push({ name, points, quantity: 0 });
            renderRewards();
            updateScores();
            saveRewards();
            nameInput.value = '';
            pointsInput.value = '';
            nameInput.focus();
        }
    });

    document.getElementById("reset-button").addEventListener("click", async () => {
      const proceed = await showConfirmModal({
        title: 'Deseja mesmo fechar a semana ?',
        confirmText: 'Fechar',
        cancelText: 'Cancelar',
        variant: 'primary'
      });
      if (!proceed) return;
      saldoAnterior = saldoAnterior + calculateWeeklyPoints() - calculateRewardsCost();
      taskChecks = {};
      rewards.forEach(r => r.quantity = 0);
      
      renderTasks();
      renderRewards();
      updateScores();
      saveRewards();
    });

    document.querySelectorAll('.tab-header').forEach(header => {
        header.addEventListener('click', () => {
            const targetTab = header.dataset.tab;
            document.querySelectorAll('.tab-header').forEach(h => h.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            header.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });
    
    // --- Inicializa√ß√£o ---
    async function checkAuthAndInit() {
      try {
        const res = await fetch('/api/me');
        if (res.ok) {
          const data = await res.json();
          document.getElementById('auth').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          // Mostrar email
          const email = (data && data.user && data.user.email) ? data.user.email : (data && data.user && data.user.displayName) ? data.user.displayName : 'Usu√°rio';
          const emailEl = document.getElementById('user-email');
          if (emailEl) emailEl.textContent = email;
          loadState();
        } else {
          document.getElementById('auth').style.display = 'block';
          document.getElementById('app').style.display = 'none';
        }
      } catch (e) {
        document.getElementById('auth').style.display = 'block';
        document.getElementById('app').style.display = 'none';
      }
    }

    function init() {
      checkAuthAndInit();
    }

    init();
  </script>
</body>
</html>

